# E2E Test Scenarios для Hiker's Voice

## TEST-002: Создание отзыва на существующего гида
**Файл:** `test_reviews.py`
**Приоритет:** Критический
**Предусловия:** Гид "Сергей Иванов" (id=1) существует в БД

**Шаги:**
1. Открыть главную страницу http://localhost:3000
2. Нажать кнопку "Оставить отзыв"
3. В модальном окне выбрать "Отзыв о гиде"
4. Заполнить форму:
   - Страна: "Россия" (RU)
   - Основной гид: ввести "Сергей" → выбрать "Сергей Иванов" из автокомплита
   - Дополнительные гиды: оставить пустым
   - Даты поездки: от 20 дней назад до 15 дней назад
   - Оценка: 4 звезды
   - Текст: "Хороший гид, знает маршруты. Немного не хватило организованности с тайм-менеджментом, но в целом всё понравилось."
   - Имя автора: оставить пустым (для проверки анонимности)
   - Контакт: "+7 900 123-45-67"
   - Согласие с правилами: отметить
5. Нажать "Отправить отзыв"
6. Дождаться редиректа на главную с параметром ?success=review_created
7. Получить ID созданного отзыва через API
8. Модерировать отзыв: POST /api/v1/test/moderate/{review_id} с {"action": "approve"}
9. Перейти на страницу гида http://localhost:3000/guides/1 и проверить что все данные корректно отображаются
10. Удалить отзыв после того, как тест прошел успешно. Если не удалился, то тест должен упасть

**Проверки:**
- Отзыв появился на странице гида
- Автор отображается как "Аноним" (так как имя не указано)
- Текст отзыва содержит совпадает с текстом который мы вводили при создании
- Рейтинг показывает 4 звезды
- Счётчик отзывов гида увеличился
- Средний рейтинг гида пересчитан
- Отзыв появился на главной странице
- Отзыв появился на странице Отзывов /reviews

---

## TEST-003: Создание новой компании
**Файл:** `test_companies.py`
**Приоритет:** Критический

**Шаги:**
1. Открыть страницу компаний http://localhost:3000/companies
2. Нажать кнопку "Добавить компанию"
3. Заполнить форму создания:
   - Название: "Test Adventure Tours {уникальный_id}"
   - Страна: "Казахстан" (KZ)
   - Описание: "Организация туров по Алтаю и Тянь-Шаню"
   - Email: "info@testadventure.kz"
   - Телефон: "+7 777 123-45-67"
   - Сайт: "https://testadventure.kz"
   - Instagram: "@testadventure"
   - Telegram: "@testadventure_bot"
   - Логотип: пропустить
4. Нажать "Создать компанию"
5. Дождаться редиректа на страницу созданной компании

**Проверки:**
- URL изменился на /companies/{new_id}
- Отображается уведомление с edit_token
- Edit_token является валидным UUID
- Все введённые данные корректно отображаются на странице
- Рейтинг показывает "Нет отзывов"
- В каталоге компаний появилась новая компания
- При поиске по названию компания находится

---

## TEST-004: Создание нового гида
**Файл:** `test_guides.py`
**Приоритет:** Критический

**Шаги:**
1. Открыть страницу гидов http://localhost:3000/guides
2. Нажать "Добавить гида"
3. Заполнить форму:
   - Имя: "Алексей Петров {уникальный_id}"
   - Страны: выбрать "Грузия" (GE) и "Армения" (AM) через чекбоксы
   - Описание: "Горный гид с 10-летним опытом"
   - Email: "alexey@guide.com"
   - Телефон: "+995 555 12-34-56"
   - Instagram: "@alexey_mountain"
   - Фото: пропустить
4. Нажать "Создать гида"
5. Дождаться редиректа на страницу гида

**Проверки:**
- URL изменился на /guides/{new_id}
- Отображается edit_token для последующего редактирования
- Имя гида отображается в заголовке
- Флаги стран GE и AM показаны рядом с именем
- Все контакты корректно отображаются
- Рейтинг: "Нет отзывов"
- Гид появился в каталоге /guides
- При фильтрации по Грузии или Армении гид находится

---

## TEST-005: Запрос на редактирование компании
**Файл:** `test_companies.py`
**Приоритет:** Критический
**Предусловия:** Существует компания "Mountain Adventures" (id=1)

**Шаги:**
1. Открыть страницу компании http://localhost:3000/companies/1
2. Нажать кнопку "Предложить изменения"
3. В модальном окне редактирования:
   - Изменить описание: добавить в конец " Лучшие туры!"
   - Изменить телефон на: "+995 322 99-88-77"
   - Изменить Instagram на: "@mountain_new"
   - Остальные поля оставить без изменений
4. Нажать "Отправить запрос"
5. Дождаться подтверждения отправки
6. Получить ID запроса через API
7. Модерировать: POST /api/v1/test/moderate-company-update/{request_id} с {"action": "approve"}
8. Обновить страницу компании

**Проверки:**
- Модальное окно закрылось после отправки
- Показано уведомление об успешной отправке запроса
- После модерации и обновления страницы:
  - Новое описание содержит "Лучшие туры!"
  - Телефон изменился на новый
  - Instagram обновлён на "@mountain_new"
- В логах модерации есть запись об изменении

---

## TEST-006: Запрос на редактирование гида
**Файл:** `test_guides.py`
**Приоритет:** Критический
**Предусловия:** Существует гид "Сергей Иванов" (id=1) с одной страной

**Шаги:**
1. Открыть страницу гида http://localhost:3000/guides/1
2. Нажать "Предложить изменения"
3. В модальном окне:
   - Добавить страну "Грузия" к существующим
   - Изменить описание на: "Обновлённое описание с опытом 15 лет"
   - Изменить email на: "sergey.new@guide.com"
4. Отправить запрос на изменение
5. Получить ID запроса
6. Модерировать через API: POST /api/v1/test/moderate-guide-update/{request_id}
7. Обновить страницу гида

**Проверки:**
- После модерации:
  - Отображаются флаги всех стран (старая + Грузия)
  - Описание содержит "15 лет"
  - Email обновлён
  - Остальные поля не изменились

---

## TEST-007: Отзыв с несуществующей компанией (автосоздание)
**Файл:** `test_reviews.py`
**Приоритет:** Критический

**Шаги:**
1. Открыть главную, нажать "Оставить отзыв"
2. Выбрать "Отзыв о компании"
3. Заполнить форму:
   - Страна: "Армения" (AM)
   - Компания: ввести полностью "Новая Тестовая Компания XYZ" (не выбирать из автокомплита)
   - Даты: любые валидные в прошлом
   - Оценка: 3 звезды
   - Текст: "Средняя организация, есть что улучшить в сервисе"
   - Автор: "Тестер"
4. Отправить отзыв
5. Получить ID отзыва
6. При модерации указать создание компании:
   ```json
   {
     "action": "approve",
     "create_company": true,
     "company_name": "Новая Тестовая Компания XYZ"
   }
   ```
7. Проверить каталог компаний

**Проверки:**
- Отзыв создан со статусом pending
- После модерации:
  - Компания "Новая Тестовая Компания XYZ" появилась в каталоге
  - Страна компании: Армения
  - Рейтинг компании: 3.0
  - Количество отзывов: 1
  - На странице компании есть созданный отзыв
  - Отзыв связан с компанией (есть кликабельная ссылка)

---

## TEST-008: Отзыв с несуществующим гидом (автосоздание)
**Файл:** `test_reviews.py`
**Приоритет:** Критический

**Шаги:**
1. Создать отзыв о гиде
2. В поле основного гида ввести: "Новый Гид Тестович" (не выбирать из автокомплита)
3. Заполнить:
   - Страна: "Украина" (UA)
   - Даты: валидные
   - Оценка: 5 звёзд
   - Текст: "Отличный новый гид!" (минимум 10 символов)
4. Отправить отзыв
5. При модерации:
   ```json
   {
     "action": "approve",
     "create_guide": true,
     "guide_name": "Новый Гид Тестович"
   }
   ```
6. Проверить каталог гидов

**Проверки:**
- Гид "Новый Гид Тестович" создан в системе
- Страна гида: Украина
- Рейтинг: 5.0 (1 отзыв)
- Отзыв на странице гида
- Гид появился в каталоге

---

## TEST-009: Отзыв с частичным гидом (только имя)
**Файл:** `test_reviews.py`
**Приоритет:** Высокий
**Предусловия:** Существует компания "Mountain Adventures"

**Шаги:**
1. Создать отзыв о компании "Mountain Adventures"
2. В секции "Гиды":
   - Нажать "Добавить гида вручную"
   - В поле "Имя" ввести: "Михаил"
   - Поле "Фамилия" оставить пустым
3. Заполнить остальные обязательные поля
4. Отправить отзыв
5. Модерировать через API (обычное approve, без создания гида)
6. Открыть отзыв на сайте

**Проверки:**
- В отзыве отображается текст "Гид: Михаил"
- Имя "Михаил" НЕ является кликабельной ссылкой
- В каталоге гидов НЕТ нового гида "Михаил"
- Частичный гид сохранён только в контексте отзыва

---

## TEST-010: Фильтрация и сортировка компаний
**Файл:** `test_filters.py`
**Приоритет:** Высокий
**Предусловия:** Минимум 5 компаний в разных странах с разными рейтингами

**Шаги:**
1. Открыть http://localhost:3000/companies
2. **Тест фильтра по стране:**
   - Выбрать в dropdown "Грузия"
   - Проверить что отображаются только грузинские компании
   - Сбросить фильтр кнопкой "Сбросить"
   - Проверить что отображаются все компании
3. **Тест поиска по названию:**
   - Ввести в поиск "Mountain"
   - Проверить что отображаются только компании содержащие "Mountain"
   - Очистить поиск
4. **Тест сортировки:**
   - Выбрать "По рейтингу ↓"
   - Проверить порядок (от большего к меньшему)
   - Выбрать "По рейтингу ↑"
   - Проверить обратный порядок
   - Выбрать "По количеству отзывов ↓"
   - Проверить сортировку по отзывам
5. **Комбинированный тест:**
   - Выбрать страну "Грузия"
   - Добавить сортировку по рейтингу
   - Ввести текст поиска
   - Проверить что все фильтры работают вместе

**Проверки:**
- URL обновляется с query параметрами при фильтрации
- При перезагрузке страницы фильтры сохраняются
- Счётчик "Найдено X компаний" корректен
- Пагинация работает с фильтрами
- Кнопка "Сбросить" очищает все фильтры

---

## TEST-011: Фильтрация и сортировка гидов
**Файл:** `test_filters.py`
**Приоритет:** Высокий
**Предусловия:** Минимум 5 гидов, некоторые с несколькими странами

**Шаги:**
1. Открыть http://localhost:3000/guides
2. **Фильтр по стране:**
   - Выбрать "Россия"
   - Проверить что показаны гиды работающие в России
   - Убедиться что гиды с несколькими странами (включая Россию) тоже показаны
3. **Поиск по имени:**
   - Ввести "Сергей"
   - Проверить фильтрацию по имени
4. **Сортировка:**
   - По рейтингу (оба направления)
   - По количеству отзывов
   - По имени (алфавитный порядок)
5. **Пагинация:**
   - Перейти на страницу 2
   - Проверить что фильтры сохранились

**Проверки:**
- Гиды с несколькими странами появляются во всех соответствующих фильтрах
- URL параметры корректны
- Счётчик результатов точен

---

## TEST-012: Фильтрация и сортировка отзывов
**Файл:** `test_filters.py`
**Приоритет:** Высокий
**Предусловия:** Минимум 10 отзывов разных типов

**Шаги:**
1. Открыть http://localhost:3000/reviews
2. **Фильтр по стране поездки:**
   - Выбрать "Грузия"
   - Проверить что показаны только отзывы о поездках в Грузию
3. **Фильтр по типу:**
   - Выбрать "Компании"
   - Проверить что только отзывы о компаниях
   - Переключить на "Гиды"
   - Проверить что только отзывы о гидах
4. **Фильтр по рейтингу:**
   - Выбрать "5 звёзд"
   - Проверить что только отличные отзывы
5. **Сортировка:**
   - "Новые первыми" (по умолчанию)
   - "Старые первыми"
   - "По рейтингу"
6. **Комбинированный фильтр:**
   - Страна "Грузия" + 5 звёзд + тип "Компания"

**Проверки:**
- Все фильтры работают независимо и в комбинации
- Счётчик "Показано X из Y отзывов" корректен
- URL обновляется с параметрами
- При обновлении страницы фильтры сохраняются

---

## TEST-013: Валидация формы отзыва
**Файл:** `test_validation.py`
**Приоритет:** Средний

**Проверки негативных сценариев:**

1. **Короткий текст:**
   - Ввести текст < 10 символов
   - Попробовать отправить
   - Проверить ошибку "Минимум 10 символов"

2. **Длинный текст:**
   - Ввести текст > 4000 символов
   - Проверить что поле не принимает больше символов
   - Счётчик показывает "4000/4000"

3. **Некорректные даты:**
   - Дата окончания раньше даты начала
   - Проверить ошибку валидации

4. **Без рейтинга:**
   - Не выбирать звёзды
   - Кнопка отправки неактивна

5. **Без согласия с правилами:**
   - Не отмечать чекбокс
   - Кнопка отправки неактивна

6. **Honeypot тест:**
   - Программно заполнить скрытое поле honeypot
   - Отправить форму
   - Проверить что отзыв НЕ создался (защита от ботов)

---

## TEST-014: Автокомплит компаний и гидов
**Файл:** `test_autocomplete.py`
**Приоритет:** Средний

**Сценарии:**

1. **Появление dropdown:**
   - Ввести 1 символ - dropdown не появляется
   - Ввести 2 символа - dropdown появляется
   - Показывается индикатор загрузки

2. **Навигация клавиатурой:**
   - Стрелка вниз - выделить следующий элемент
   - Стрелка вверх - выделить предыдущий
   - Enter - выбрать выделенный элемент
   - Esc - закрыть dropdown

3. **Выбор мышью:**
   - Клик на элемент выбирает его
   - Клик вне dropdown закрывает его

4. **Поиск без результатов:**
   - Ввести несуществующее название
   - Показывается "Ничего не найдено"

5. **Множественный выбор гидов:**
   - Выбрать первого гида из автокомплита
   - Поле очищается для ввода следующего
   - Выбрать второго гида
   - Оба гида отображаются с кнопками удаления

---

## TEST-015: Множественные гиды в отзыве
**Файл:** `test_reviews.py`
**Приоритет:** Низкий

**Шаги:**
1. Начать создание отзыва о компании
2. В секции гидов:
   - Добавить основного гида из автокомплита (пометка "Основной")
   - Добавить второго гида из автокомплита
   - Добавить третьего гида вручную (только имя "Иван")
   - Добавить четвёртого гида вручную (имя "Пётр", фамилия "Сидоров")
   - Попробовать добавить 6-го гида
3. Проверить ограничение на 5 гидов
4. Удалить одного гида кнопкой ×
5. Добавить нового на его место
6. Отправить отзыв и модерировать

**Проверки:**
- Максимум 5 гидов (показывается ошибка при попытке добавить 6-го)
- Основной гид помечен специальным бейджем
- Гиды из БД - ссылки на их страницы
- Частичные гиды - просто текст без ссылок
- Кнопки × удаляют гидов из списка
- В опубликованном отзыве все гиды отображаются корректно