# Hiker's Voice - Система Автоматизированного Тестирования

## Философия проекта

Минимум усложнения, максимум ясности. Тесты должны быть простыми, поддерживаемыми и запускаться локально перед пушем в прод. Никаких лишних абстракций и переусложнений.

## Реализованные тесты

### TEST-001: Создание отзыва на компанию с автокомплитом
- Проверка создания отзыва на компанию
- Использование автокомплита для выбора компании
- Модерация через API
- Проверка отображения на всех страницах

### TEST-002: Создание отзыва на существующего гида
- Создание анонимного отзыва на гида
- Использование автокомплита для выбора гида
- Математическая проверка пересчёта рейтинга
- Учёт округления backend (толерантность 0.05)
- Проверка отображения на трёх страницах: гида, главной и /reviews

## Структура проекта

```
hikers_voice_tests/
├── conftest.py              # Главная конфигурация pytest
├── pytest.ini               # Настройки pytest
├── requirements.txt         # Зависимости проекта
│
├── pages/                   # Page Objects паттерн
│   ├── __init__.py         
│   ├── base_page.py        # Базовый класс с общими методами
│   ├── home_page.py        # Главная страница
│   ├── review_form_page.py # Формы создания отзывов
│   ├── guide_page.py       # Страница гида (NEW)
│   └── reviews_page.py     # Страница всех отзывов (NEW)
│
├── tests/                   # Тесты
│   ├── conftest.py         # E2E конфигурация
│   └── test_reviews.py     # Тесты отзывов (TEST-001, TEST-002)
│
├── fixtures/                # Тестовые данные
│   ├── __init__.py
│   └── test_data.py        # Генераторы данных
│
└── utils/                   # Утилиты
    ├── __init__.py
    ├── test_helper.py      # API хелперы
    └── rating_calculator.py # Калькулятор рейтингов (NEW)
```

## Ключевые компоненты

### Page Objects

#### GuidePage (новый)
Работа со страницей гида `/guides/{id}`:
- `open_guide_page(guide_id)` - открытие страницы гида
- `get_guide_rating()` - получение среднего рейтинга
- `get_reviews_count()` - подсчёт отзывов
- `check_review_exists()` - проверка наличия отзыва
- `check_review_rating()` - проверка звёзд (исправлено для подсчёта заполненных)

#### ReviewsPage (новый)
Работа со страницей всех отзывов `/reviews`:
- `check_review_exists()` - поиск отзыва по автору/тексту
- `find_review_by_author()` - поиск по автору (включая анонимов)
- `search_reviews()` - поиск через поисковую строку

#### ReviewFormPage (обновлён)
Добавлены методы для работы с гидами:
- `fill_guide_name_with_autocomplete()` - автокомплит для выбора гида
- `fill_author_info()` - обработка пустого имени для анонимности

### Утилиты

#### RatingCalculator (новый)
Математически точные расчёты рейтингов:
```python
# Формула backend:
avg_rating = SUM(все рейтинги) / COUNT(отзывов)

# Методы:
calculate_new_rating()  # Расчёт нового рейтинга
verify_rating_change()  # Проверка корректности с толерантностью
get_expected_impact()   # Прогноз влияния отзыва
```

## Решённые проблемы

### 1. Подсчёт звёзд в отзывах
**Проблема:** Компонент Rating всегда рендерит 5 SVG элементов

**Решение:** Считаем только заполненные звёзды с классом `text-yellow-400`:
```python
filled_stars = await review_element.locator("svg.text-yellow-400").count()
```

### 2. Округление рейтингов
**Проблема:** Backend округляет до 1 десятичного знака

**Пример:**
- Математически: (5.0 × 2 + 4) ÷ 3 = 4.666...
- Backend возвращает: 4.7

**Решение:** Толерантность 0.05 в проверках:
```python
verify_rating_change(..., tolerance=0.05)
```

### 3. Анонимные отзывы
**Особенность:** Пустое имя автора сохраняется как "Аноним"

**Решение:** 
```python
# При поиске анонимного отзыва
await test_helper.find_and_moderate_review(
    author_name="Аноним",  # Не пустая строка
    action="approve"
)
```

## Паттерны написания тестов

### Структура теста (AAA)
```python
async def test_feature():
    # Arrange - подготовка данных
    review_data = {...}
    
    # Act - выполнение действий
    page_object = PageObject(page)
    await page_object.action()
    
    # Assert - проверка результатов
    assert condition, "Clear error message"
```

### Линейная логика
- Никаких сложных ветвлений
- Минимум условных операторов
- Последовательные проверки

### Минималистичное логирование
- Только финальное сообщение об успехе
- Никаких промежуточных логов в тесте
- Детальное логирование в Page Objects при необходимости

## Запуск тестов

### Быстрый старт
```bash
# Установка зависимостей
pip install -r requirements.txt

# Запуск TEST-002
pytest tests/test_reviews.py::test_create_guide_review_with_autocomplete -v

# Все тесты отзывов
pytest tests/test_reviews.py -v

# С визуальным браузером
pytest tests/test_reviews.py --slow-mo=500

# В headless режиме
pytest tests/test_reviews.py --headless
```

## Предусловия

1. **Backend** запущен на http://localhost:8000
2. **Frontend** запущен на http://localhost:3000
3. **База данных** содержит seed данные:
   - Георгий Челидзе (guide id=1)
   - Mountain Tours компании

## Важные соглашения

### Приоритет селекторов
1. `data-testid` - специальные атрибуты для тестов
2. `id` - уникальные идентификаторы
3. `className` - CSS классы
4. `name` - для полей форм
5. `text` - для кнопок и ссылок

### Правила кода
- **Используйте** существующие Page Objects
- **Следуйте** паттерну AAA
- **Добавляйте** понятные assert сообщения
- **НЕ создавайте** новые конфиги
- **НЕ используйте** time.sleep()
- **НЕ хардкодьте** данные

## Отладка

### Если тест падает
1. Проверьте селекторы в DevTools
2. Посмотрите логи Page Objects
3. Проверьте seed данные в БД
4. Запустите с `--slow-mo=1000` для визуальной отладки

### Частые проблемы

| Проблема | Решение |
|----------|---------|
| Селектор не найден | Проверьте актуальность в коде фронтенда |
| Рейтинг не совпадает | Учтите округление до 0.1 |
| Cleanup падает | Проверьте admin credentials |
| Автокомплит не работает | Добавьте wait_for_timeout после ввода |

## Документация тестов

- **TEST-001** - базовый тест создания отзыва на компанию
- **TEST-002** - комплексный тест отзыва на гида с проверкой рейтинга
- **TEST-002-FIXES.md** - исправления проблемы подсчёта звёзд
- **TEST-002-ROUNDING.md** - объяснение округления рейтингов

---

**Принцип проекта:** Простые, надёжные тесты, которые работают из коробки и легко поддерживаются.
