# Hiker's Voice - Система Автоматизированного Тестирования

## Философия проекта

Минимум усложнения, максимум ясности. Тесты должны быть простыми, поддерживаемыми и запускаться локально перед пушем в прод. Никаких лишних абстракций и переусложнений.

## Статус тестов ✅

| Тест | Описание | Статус | Файл |
|------|----------|--------|------|
| TEST-001 | Создание отзыва на компанию с автокомплитом | ✅ Работает | `test_reviews.py::test_create_company_review_with_autocomplete` |
| TEST-002 | Создание отзыва на гида с автокомплитом | ✅ Работает | `test_reviews.py::test_create_guide_review_with_autocomplete` |
| TEST-004 | Валидация формы отзыва (компания и гид) | ✅ Работает | `test_reviews.py::test_review_form_validation_errors` |
| TEST-005 | Загрузка фотографий в отзывы (граничные значения) | ✅ Работает | `test_photo_upload.py::test_review_with_photos` |

## Реализованные тесты

### TEST-001: Создание отзыва на компанию с автокомплитом
- ✅ Проверка создания отзыва на компанию
- ✅ Использование автокомплита для выбора компании "Svaneti"
- ✅ Модерация через тестовый API
- ✅ Проверка отображения на главной странице
- ✅ Проверка полного текста на странице отзыва
- ✅ Параметризованный тест с разными рейтингами (1-5)

### TEST-002: Создание отзыва на существующего гида
- ✅ Создание анонимного отзыва на гида "Георгий Челидзе"
- ✅ Использование автокомплита для выбора гида
- ✅ Правильная привязка отзыва к гиду через EntityLinker
- ✅ Математическая проверка пересчёта рейтинга с толерантностью 0.05
- ✅ Проверка отображения на трёх страницах: гида, главной и /reviews
- ✅ Проверка корректного подсчёта звёзд в отзывах

### TEST-004: Валидация формы отзыва (параметризованный тест)
- ✅ **Параметризация:** Тест запускается для формы компании И формы гида
- ✅ Проверка блокировки кнопки "Отправить" при пустой форме
- ✅ Валидация минимальной длины текста отзыва (10 символов)
- ✅ Валидация максимальной длины текста отзыва (4000 символов)
- ✅ Проверка обязательности заполнения всех полей
- ✅ Проверка обязательности принятия правил публикации
- ✅ Реактивность формы: изменения полей влияют на состояние кнопки
- ✅ Проверка, что кнопка активируется только при валидной форме

### TEST-005: Загрузка фотографий в отзывы (параметризованный тест)
- ✅ **Параметризация:** 4 комбинации (company/guide × 1/5 фото)
- ✅ Загрузка и проверка превью фотографий в форме
- ✅ Отправка формы с фотографиями
- ✅ Проверка отображения фотогалереи на странице отзыва
- ✅ Тестирование lightbox (открытие, счетчик, навигация, закрытие)
- ✅ Автоматическая очистка тестовых отзывов с фотографиями
- ✅ **Граничные значения:** 1 фото (минимум) и 5 фото (максимум)

**Особенности TEST-005:**
```python
@pytest.mark.parametrize("review_type,photo_count", [
    ("company", 1),  # Минимум фото
    ("company", 5),  # Максимум фото
    ("guide", 1),
    ("guide", 5),
])
```

## Структура проекта

```
hikers_voice_tests/
├── conftest.py              # Главная конфигурация pytest
├── pytest.ini               # Настройки pytest
├── requirements.txt         # Зависимости проекта (включая Pillow для генерации изображений)
├── README.md               # Этот файл
│
├── pages/                   # Page Objects паттерн
│   ├── __init__.py         
│   ├── base_page.py        # Базовый класс с общими методами
│   ├── home_page.py        # Главная страница
│   ├── review_form_page.py # Формы создания отзывов + загрузка фото
│   ├── guide_page.py       # Страница гида
│   └── reviews_page.py     # Страница всех отзывов + фотогалерея
│
├── tests/                   # Тесты
│   ├── conftest.py         # E2E конфигурация и фикстуры
│   ├── test_reviews.py     # Тесты отзывов TEST-001, TEST-002, TEST-004
│   └── test_photo_upload.py # Тесты загрузки фото TEST-005
│
├── fixtures/                # Тестовые данные
│   ├── __init__.py
│   ├── test_data.py        # Генераторы тестовых данных
│   ├── test_images_fixtures.py # Фикстуры для тестовых изображений
│   └── test_images/        # Сгенерированные тестовые изображения
│       ├── test_photo_1.jpg ... test_photo_7.jpg
│       ├── large_test_photo.jpg
│       └── invalid_file.txt
│
└── utils/                   # Утилиты
    ├── __init__.py
    ├── test_helper.py      # API хелперы для модерации
    ├── rating_calculator.py # Математика расчёта рейтингов
    └── image_generator.py  # Генератор тестовых изображений
```

## Запуск тестов

### Быстрый старт
```bash
# Установка зависимостей
pip install -r requirements.txt

# Генерация тестовых изображений (только первый раз)
python utils/image_generator.py

# Запуск всех тестов
pytest tests/ -v

# Запуск тестов отзывов
pytest tests/test_reviews.py -v

# Запуск тестов загрузки фото
pytest tests/test_photo_upload.py -v

# Запуск только с 1 фото
pytest tests/test_photo_upload.py -k "1" -v

# Запуск только с 5 фото
pytest tests/test_photo_upload.py -k "5" -v

# С визуальным браузером (медленно)
pytest tests/ --slow-mo=500

# В headless режиме (быстро)
pytest tests/ --headless

# Только критичные тесты
pytest -m critical
```

## Предусловия

### Обязательные требования
1. **Backend** запущен на `http://localhost:8000`
2. **Frontend** запущен на `http://localhost:3000`
3. **База данных** содержит seed данные:
   - Гид: Георгий Челидзе (id=1)
   - Компании с "Svaneti" в названии
4. **Тестовые эндпоинты** включены (APP_ENV=dev)
5. **Pillow** установлен для генерации тестовых изображений
6. **Тестовые изображения** сгенерированы в `fixtures/test_images/`

### Проверка готовности
```bash
# Проверка Backend
curl http://localhost:8000/healthz

# Проверка Frontend
curl http://localhost:3000

# Проверка тестовых изображений
ls -l fixtures/test_images/test_photo_*.jpg
```

## Важные фикстуры

### clean_test_review
Автоматически удаляет созданные отзывы после теста через admin panel endpoint.
Тест **упадёт**, если удаление не удалось - это предотвращает накопление тестовых данных.

### test_images
Предоставляет список путей к 7 тестовым изображениям:
```python
@pytest.fixture(scope="session")
def test_images(test_images_dir: Path) -> list[str]:
    # Возвращает пути к test_photo_1.jpg ... test_photo_7.jpg
```

## Паттерны написания тестов

### Правила кода
- ✅ **Используйте** существующие Page Objects
- ✅ **Следуйте** паттерну AAA (Arrange-Act-Assert)
- ✅ **Добавляйте** понятные assert сообщения
- ✅ **Используйте** фикстуры вместо хардкода
- ✅ **Тесты должны быть линейными** - без fallback логики
- ❌ **НЕ создавайте** новые конфиги
- ❌ **НЕ используйте** time.sleep() - только wait_for_*
- ❌ **НЕ хардкодьте** данные - используйте фикстуры
- ❌ **НЕ добавляйте** fallback в тесты - пусть падают при багах

## Решенные проблемы 🔧

### 1. Lightbox навигация с двумя парами кнопок
**Проблема:** PhotoGallery рендерит две пары кнопок навигации - desktop (visible) и mobile (hidden). Playwright находил первую пару (mobile), которая была `visibility: hidden`.

**Решение:** Уточнены селекторы для поиска именно desktop версии кнопок:
```python
PHOTO_LIGHTBOX_NEXT = "button[aria-label='Следующая фотография'].sm\\:block"
PHOTO_LIGHTBOX_PREV = "button[aria-label='Предыдущая фотография'].sm\\:block"
```

### 2. Проверка типа формы в wait_for_review_form()
**Проблема:** Метод `wait_for_review_form()` всегда ждал поле компании, что ломало тесты с гидами.

**Решение:** Добавлен параметр `review_type` для ожидания правильного поля:
```python
async def wait_for_review_form(self, review_type: str = "company"):
    await self.wait_for_element(self.COUNTRY_SELECT, timeout=10000)
    if review_type == "company":
        await self.wait_for_element(self.COMPANY_NAME_INPUT, timeout=5000)
    else:  # guide
        await self.wait_for_element(self.GUIDE_NAME_INPUT, timeout=5000)
```

## Отладка

### Частые проблемы и решения

| Проблема | Причина | Решение |
|----------|---------|---------|
| ModuleNotFoundError: No module named 'PIL' | Pillow не установлен | `pip install Pillow` |
| Тестовые изображения не найдены | Не сгенерированы | `python utils/image_generator.py` |
| Lightbox кнопки не найдены | Неправильный селектор | Используйте `.sm\\:block` для desktop кнопок |
| wait_for_review_form() падает на гидах | Ждёт поле компании | Передайте `review_type="guide"` |
| Cleanup падает | Нет прав или объект не найден | Проверьте admin credentials в conftest.py |

### Запуск с отладкой
```bash
# Визуальный режим с паузами
pytest tests/test_photo_upload.py --slow-mo=1000

# С выводом всех логов
pytest tests/test_photo_upload.py -v -s --log-cli-level=INFO

# Конкретный тест
pytest tests/test_photo_upload.py::test_review_with_photos[company-5] -vvv
```

## Будущие улучшения

### Планируется
- [ ] TEST-006: Валидация загрузки фото (размер >5МБ, неверный формат)
- [ ] TEST-007: Удаление фото из формы перед отправкой
- [ ] TEST-008: Редактирование отзыва модератором
- [ ] Тесты для many-to-many связей (несколько гидов в отзыве)
- [ ] API тесты без UI

### Технический долг
- [ ] Параллельный запуск тестов
- [ ] Генерация HTML отчётов
- [ ] CI/CD интеграция

---

**Принцип проекта:** Простые, надёжные тесты, которые работают из коробки и легко поддерживаются.

**Последнее обновление:** Октябрь 2024  
**Версия:** 1.4.0
